import { useState, useRef, useCallback, useMemo, useEffect, useReducer } from "react";

// ============================================================
// C2A Student Profile v12 — DDx-Aligned (Optimized for Scannability)
//
// Architecture: Built FROM schema.json outward.
// Three views: My Profile (student) | Full Picture (coach) | Explore
// Student view: 2-column grid layout for side-by-side "Action" and "Roots"
// Coach view: v9 radar with full interactivity + DDx schema drawer
// Data contract: field names match schema.json exactly
// Voice: preamble.md principles (honest, adult, strengths-first)
// ============================================================

/* ─── Design Tokens ─── */
const C = {
  bg: "#f0f4f8", card: "#ffffff", cardHover: "#f8fafc",
  text: "#0f172a", mid: "#475569", light: "#94a3b8", faint: "#cbd5e1",
  border: "#e2e8f0", borderDark: "#cbd5e1",
  ring: "#b0bec5",
  blocker: "#dc2626", watch: "#2563eb", clear: "#16a34a",
  blockerBg: "#fef2f2", watchBg: "#eff6ff", clearBg: "#f0fdf4",
  blockerDark: "#991b1b", watchDark: "#1e40af", clearDark: "#15803d",
  highlight: "#eab308", highlightLight: "#fef08a", highlightDark: "#a16207",
  purple: "#7c3aed", purpleBg: "#faf5ff", purpleDark: "#5b21b6",
  pink: "#ec4899", pinkBg: "#fdf2f8", pinkDark: "#9d174d",
};

const T = { xxs: "0.6rem", xs: "0.68rem", sm: "0.78rem", base: "0.88rem", md: "1rem", lg: "1.15rem", xl: "1.4rem", xxl: "1.85rem" };
const S = { xs: 4, sm: 8, md: 12, lg: 16, xl: 20, xxl: 24, xxxl: 32 };

/* ─── Tier System ─── */
const TIERS = [
  { id: "blocker", label: "Start Here", coachLabel: "Blocker", color: C.blocker, bg: C.blockerBg, dark: C.blockerDark, desc: "These are holding other skills back. Highest leverage." },
  { id: "watch",   label: "Building",   coachLabel: "Watch",   color: C.watch,   bg: C.watchBg,   dark: C.watchDark,   desc: "Developing — targeted practice will move these." },
  { id: "clear",   label: "Working For You", coachLabel: "Clear", color: C.clear, bg: C.clearBg, dark: C.clearDark, desc: "Current strengths. Build on these." },
];
const TM = {}; TIERS.forEach(t => TM[t.id] = t);

/* ─── Pillar Definitions (Lens 1: Durable Skills) ─── */
const PILLARS = [
  { id: "cct", name: "Creative & Curious Thinkers", color: "#2563eb", light: "#93c5fd", dark: "#1e3a5f", tagline: "How you think, create, and adapt" },
  { id: "lpa", name: "Leaders with Purpose & Agency", color: "#dc2626", light: "#fca5a5", dark: "#7f1d1d", tagline: "How you lead, connect, and take initiative" },
  { id: "tic", name: "Thrivers in Change", color: "#16a34a", light: "#86efac", dark: "#14532d", tagline: "How you handle setbacks and work with others" },
  { id: "nb",  name: "Network Builders", color: "#f59e0b", light: "#fde68a", dark: "#78350f", tagline: "How you build and navigate relationships" },
];

/* ─── EF + ARC Dimension Definitions (Lens 2 + 3) ─── */
const EF_DIMS = [
  { id: "wm", abbr: "WM", name: "Working Memory", gloss: "How much you can hold in mind at once" },
  { id: "ih", abbr: "IH", name: "Inhibition", gloss: "How quickly your first reaction takes over" },
  { id: "cf", abbr: "CF", name: "Cognitive Flexibility", gloss: "How easily you shift between ideas or approaches" },
];

const ARC_DIMS = [
  { id: "aut", abbr: "AU", name: "Autonomy", gloss: "Your sense of choice and control" },
  { id: "comp", abbr: "CP2", name: "Competence", gloss: "Your sense of effectiveness — whether effort leads to results" },
  { id: "relat", abbr: "RL", name: "Relatedness", gloss: "Your sense of connection and belonging" },
];

/* ─── Flat group map for radar (all 6 groups including EF + ARC) ─── */
const GROUPS = [
  ...PILLARS.map(p => ({ ...p })),
  { id: "ef",  name: "Executive Function", color: "#7c3aed", light: "#c4b5fd", dark: "#4c1d95", tagline: "Your cognitive processing" },
  { id: "arc", name: "ARC Needs", color: "#ec4899", light: "#f9a8d4", dark: "#831843", tagline: "Your motivational foundation" },
];
const GM = {}; GROUPS.forEach(g => GM[g.id] = g);

/* ─── Skills Data (schema.json aligned) ─── */
const DURABLE_SKILLS = [
  { id:"crit",  abbr:"CT",  name:"Critical Thinking",       pillar:"cct", score:45, tier:"watch",
    strategyType:"compensate_change", strategyLabel:"Structured Compensation", efTier:2, arcState:"clear",
    studentText:{ strengthsLead:"Your reasoning is strong when you can focus on a single source. That ability is real — the challenge is about juggling, not thinking.", possiblePatterns:["You may start strong on complex projects but lose track of the key arguments partway through.","You may avoid tasks that require holding multiple perspectives at once, choosing simpler approaches even when you're capable of more."], insightBody:"Your critical thinking is solid when focused on a single source or argument. Where it gets harder is when you need to hold and compare multiple perspectives simultaneously — that's where working memory load creates friction. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"When juggling multiple sources, simple external structure helps your reasoning shine.", nextStep:"Before your next analysis task, try the Fact–Assumption–Question split: sort your evidence into three columns." },
    coachText:{ coachingDirection:"This student's reasoning quality is strong when the load is manageable — a good starting point is external frameworks that hold the pieces so the thinking doesn't compete with the organizing.", strengthsLeverage:"Strong single-thread reasoning. Use 1:1 discussion to surface quality that gets lost in multi-source tasks.", clinicalSummary:"WM constraint reduces simultaneous comparison capacity. CogFlex adequate when not overloaded. Quality is visible when load is managed.", hypotheses:"Primary: WM capacity limitation affecting multi-source analysis. Consider: Environmental barriers (noisy, fragmented tasks). Consider: Assessment artifact — reasoning quality obscured by format demands.", ruleOutChecklist:["Check whether environmental factors (noise, fragmentation) are creating unnecessary WM load","Rule out assessment artifact — does reasoning quality improve in discussion vs. written formats?","Check cultural reasoning styles — does the student use narrative or relational logic the instrument doesn't capture?"], ruleOutPrompt:"Before attributing this pattern to WM capacity alone, check these possibilities:", scaffoldSequence:"A good starting point might be an external workspace — a template that holds the pieces — so the student's thinking isn't competing with the organizing. Once the tool is landing, look at the environment: can tasks be restructured to reduce simultaneous demands? Then build toward unscaffolded multi-source work through progressively harder practice. If structured supports do not improve performance within 4 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the reasoning quality visible in focused work — show the student their own strength.\nGrowth Edge: Show where the thread was lost in multi-source tasks — make the WM pattern visible without judgment.\nNext Step: Introduce the organizer for the next multi-source assignment.", equityNote:"A student from a tradition that values narrative or relational reasoning may score lower on an instrument designed for analytical logic. Low scores here might mean 'reasons differently,' not 'reasons poorly.'" } },
  { id:"cps",  abbr:"CP",  name:"Creative Problem Solving", pillar:"cct", score:72, tier:"clear",
    strategyType:"skill_coaching", strategyLabel:"Direct Skill Coaching", efTier:0, arcState:"clear",
    studentText:{ strengthsLead:"You shift between ideas naturally and spot directions others miss. When the pressure is manageable, your creative thinking works well.", possiblePatterns:["You generate ideas quickly and see connections others miss.","You may commit to a direction before fully evaluating alternatives."], insightBody:"Your creative problem solving benefits from strong cognitive flexibility — you shift between ideas easily. The growth edge is in the pause: your first impulse is often good, but a brief check before committing helps you pick the best option, not just the fastest. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"A short pause before committing helps you choose intentionally.", nextStep:"Try a Constraint Flip: list your top 2 limits, then solve with them instead of around them." },
    coachText:{ coachingDirection:"This student's creative capacity is a genuine asset — the growth edge is adding a brief convergent check before commitment.", strengthsLeverage:"Natural divergent thinker. Creative recombination is strong. Use as anchor for engagement.", clinicalSummary:"CogFlex asset supports creative ideation. Mild inhibition pattern means first-impulse may bypass best solution.", hypotheses:"Primary: Strong creative capacity with mild convergent-selection gap. Consider: Task structures that force premature commitment.", ruleOutChecklist:["Check whether task structures are forcing premature convergence","Rule out assessment artifact — does creative quality differ across contexts?","Check whether quick commitment reflects confidence, not impulsivity"], ruleOutPrompt:"This is a strength profile — check whether the growth edge is real or contextual:", scaffoldSequence:"Direct skill-building is productive here. A brief pause protocol before final decisions creates space for convergent evaluation without dampening divergent output. If structured supports do not improve performance within 2 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the creative patterns — idea generation, connections, novel combinations.\nGrowth Edge: Show moments where the first impulse bypassed a better option.\nNext Step: Install a brief check — 'Is this the best idea, or just the first one?'", equityNote:"Creative expression varies by culture. A student whose creativity manifests through storytelling or improvisation may not show up on a framework-based assessment." } },
  { id:"curio", abbr:"CU",  name:"Curiosity", pillar:"cct", score:70, tier:"clear",
    strategyType:"pure_skill_gap", strategyLabel:"Direct Skill Building", efTier:0, arcState:"clear",
    studentText:{ strengthsLead:"You seek out new information and engage deeply when a topic catches your interest. That drive is genuine.", possiblePatterns:["You seek new information independently and explore topics that interest you.","You engage most deeply when intrinsic interest is high — less so when the topic feels assigned."], insightBody:"Your curiosity is a genuine asset. You engage deeply with topics that interest you, and that drive can be channeled to pull you into areas that feel harder right now. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"Connecting new topics to existing interests keeps your engagement high.", nextStep:"Pick one thing from a difficult course and find a connection to something you already care about." },
    coachText:{ coachingDirection:"This student's curiosity is an engagement lever — use it to pull them into growth areas rather than pushing from outside.", strengthsLeverage:"High intrinsic motivation when interest is engaged. Use curiosity as bridge to harder material.", clinicalSummary:"No EF constraint on curiosity. Interest-dependent engagement is a strength pattern, not a deficit.", hypotheses:"Primary: Strength — genuine intellectual curiosity. Note: Interest-dependent engagement may look like inconsistency but reflects a motivational pattern, not a skill gap.", ruleOutChecklist:["Distinguish interest-dependent engagement from task avoidance","Check whether disengagement from certain topics reflects topic mismatch, not curiosity deficit","Consider whether assessment captured breadth of curiosity expression"], ruleOutPrompt:"This is a strength — verify it's being recognized:", scaffoldSequence:"Direct skill-building only. Channel existing curiosity into growth areas through connection-making. If structured supports do not improve performance within 2 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the curiosity patterns — independent exploration, deep engagement.\nGrowth Edge: Show where curiosity could extend into less familiar territory.\nNext Step: Connect one growth area to an existing interest.", equityNote:"Curiosity expression varies by culture and context. A student who explores through conversation rather than independent research may appear less curious on a self-report instrument." } },
  { id:"init",  abbr:"IN",  name:"Initiative", pillar:"lpa", score:22, tier:"blocker",
    strategyType:"compensate_need_high", strategyLabel:"Structured Compensation + Need Restoration", efTier:2, arcState:"blocker",
    studentText:{ strengthsLead:"You genuinely want to follow through — that motivation shows up when conditions support it. The gap is about structure, not drive.", possiblePatterns:["You have strong intentions but inconsistent follow-through, especially when tasks have multiple steps.","You perform noticeably better with external structure, accountability, or a clear next step."], insightBody:"The gap between wanting to do something and actually starting isn't about motivation — yours is real. It's about the bridge between intention and action. When the load of holding plans in mind is high and impulse control is stretched, plans get lost before they become steps. At the same time, repeated experiences where effort didn't lead to results have made it harder to believe the next attempt will be different. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"Making the next step visible and concrete helps intentions become actions. Rebuilding trust in your own effectiveness matters too.", nextStep:"Choose ONE task today. Write: 'When [specific time/place], I will [one specific action].' Many students show this pattern — it responds well to the right support." },
    coachText:{ coachingDirection:"Dual EF constraint (WM+Inh) creates intention-action gap, compounded by competence frustration. Stabilize both axes — EF supports and need restoration proceed in parallel, both before productive skill-building.", strengthsLeverage:"Genuine motivation is intact. When external structure is provided, follow-through improves markedly — that's evidence of capacity, not dependence.", clinicalSummary:"WM cannot hold multi-step plans during execution. Inhibition allows distractors to override intentions. Combined: intentions rarely convert to action. Competence need is actively frustrated — student doesn't believe effort leads to results, reducing willingness to start.", hypotheses:"Primary: Dual EF constraint creating structural intention-action gap. Contributing: competence frustration reducing initiation willingness. Consider: Learned helplessness from accumulated failure experiences. Consider: Environmental deficit — insufficient external structure in current context.", ruleOutChecklist:["Check for ADHD — this pattern overlaps significantly with executive dysfunction in ADHD","Rule out learned helplessness from repeated failure as primary driver vs. EF constraint","Check environmental deficit — is the student in a context that provides no external structure?","Consider whether language or code-switching demands are consuming WM resources","Check cultural norms around initiative expression — some cultures value collective over individual action"], ruleOutPrompt:"Before attributing this pattern to EF constraint alone, check these critical possibilities:", scaffoldSequence:"A good starting point might be implementation intentions — 'when X, I will Y' — that externalize the WM-dependent planning step. Pair with environmental accommodations that reduce competing demands. In parallel, address the competence frustration: create early wins that rebuild the student's trust in effort-to-outcome connection. Once both supports are landing, build toward self-initiated planning through progressively less scaffolded tasks. If structured supports do not improve performance within 4 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the intention quality — this student wants to act, and that motivation is genuine.\nGrowth Edge: Show the intention-action gap pattern without judgment — where plans get lost between forming and executing.\nNext Step: Install one implementation intention for the next 48 hours.", equityNote:"Initiative expression varies significantly by culture. A student from a collectivist background may show initiative through group coordination rather than individual action — this instrument may not capture that. Additionally, the 'intention-action gap' pattern overlaps with ADHD and should not be attributed to character." } },
  { id:"comm",  abbr:"CM",  name:"Communication", pillar:"lpa", score:48, tier:"watch",
    strategyType:"scaffold_targeted_monitor", strategyLabel:"Targeted Scaffold + Need Monitoring", efTier:1, arcState:"watch",
    studentText:{ strengthsLead:"You communicate clearly in 1:1 or structured settings — that quality is real.", possiblePatterns:["You communicate clearly in 1:1 or structured settings.","You lose the thread in fast-paced group discussions when multiple people are talking."], insightBody:"Your communication quality is strong when the setting supports it — 1:1 conversations bring out your best thinking. In faster-paced groups, the load of tracking multiple threads creates friction that doesn't reflect your actual ability. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"Supports that track the thread make group participation easier.", nextStep:"Before your next group discussion, write down the one point you want to make." },
    coachText:{ coachingDirection:"This student's communication quality is strong in manageable settings — a good starting point is light scaffolding for group contexts while monitoring whether autonomy strain is affecting engagement.", strengthsLeverage:"Strong 1:1 communication. Use structured dyad work to extend into larger groups.", clinicalSummary:"WM constraint reduces real-time conversational tracking in multi-party settings. Quality is strong when load is managed. Autonomy need is strained but not in crisis.", hypotheses:"Primary: WM overload in multi-party settings. Consider: Social anxiety presenting as WM overload. Consider: Language or code-switching demands consuming WM resources.", ruleOutChecklist:["Check whether social anxiety is driving avoidance of group settings vs. WM load","Rule out language or code-switching demands as primary WM consumer","Check cultural communication norms — does the student come from a context where turn-taking is different?"], ruleOutPrompt:"Communication in groups involves multiple factors — check these before focusing on WM:", scaffoldSequence:"A good starting point might be a pre-discussion note — one key point written down before the conversation starts. This reduces the WM load of generating and holding the thought simultaneously. In parallel, monitor the autonomy signal: offer choice in how and when the student contributes. If structured supports do not improve performance within 3 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the communication quality visible in 1:1 settings — show the student their own standard.\nGrowth Edge: Compare 1:1 vs. group quality — make the load pattern visible.\nNext Step: Pre-write one key point before the next group discussion.", equityNote:"Communication norms vary dramatically across cultures. A student who waits for a pause before speaking may be following cultural norms, not struggling with WM. Direct, assertive communication styles are not universally valued." } },
  { id:"emp",  abbr:"EM",  name:"Empathy", pillar:"lpa", score:78, tier:"clear",
    strategyType:"pure_skill_gap", strategyLabel:"Direct Skill Building", efTier:0, arcState:"clear",
    studentText:{ strengthsLead:"You naturally shift into others' perspectives and pick up on how people feel. That capacity is genuine.", possiblePatterns:["You naturally take others' perspectives and notice emotional dynamics.","You often find yourself mediating tension in group settings."], insightBody:"Empathy is one of your strongest assets. You naturally take others' perspectives and mediate tension. This capacity is a foundation you can build on across other interpersonal skills. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"Use this strength as a scaffold for building communication and social awareness in group settings.", nextStep:"When your team disagrees, try finding one piece of common ground before offering your own position." },
    coachText:{ coachingDirection:"This student's empathy is a genuine cross-cutting asset — use it as an anchor for building other interpersonal skills.", strengthsLeverage:"Natural perspective-taker. This is a bridge capacity — use it to scaffold Communication, Social Awareness, and Collaboration growth.", clinicalSummary:"No EF constraint on empathy. High relatedness satisfaction supports empathic capacity.", hypotheses:"Primary: Strength — genuine empathic capacity. Note: Watch for empathy fatigue in high-demand interpersonal contexts.", ruleOutChecklist:["Monitor for empathy fatigue in contexts with high emotional demand","Check whether empathy expression is being over-relied on as a coping strategy","Consider whether the student's empathic role in groups is by choice or default"], ruleOutPrompt:"This is a strength profile — ensure it's being leveraged, not overtaxed:", scaffoldSequence:"Direct skill-building only. Channel empathic capacity into structured interpersonal growth. If structured supports do not improve performance within 2 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the empathy patterns — perspective-taking, tension mediation, emotional attunement.\nGrowth Edge: Show where empathy can serve as a bridge to growth in other interpersonal skills.\nNext Step: Deploy empathy in one structured group task.", equityNote:"Empathy expression varies by culture. A student from a high-context culture may show empathy through indirect communication the instrument doesn't capture." } },
  { id:"resil", abbr:"RE",  name:"Resilience", pillar:"tic", score:38, tier:"watch",
    strategyType:"scaffold_targeted_monitor", strategyLabel:"Targeted Scaffold + Need Monitoring", efTier:1, arcState:"watch",
    studentText:{ strengthsLead:"You have clear goals and real determination. Your ability to recover shows up when someone helps you reconnect with your original aim.", possiblePatterns:["You have clear goals but get derailed by the emotional flood after a setback.","You recover well when someone reminds you of your original aim or helps you reframe."], insightBody:"Your resilience challenge isn't about lacking toughness — it's about what happens after a setback. When your first reaction takes over quickly, the emotional response arrives before your coping strategies can engage. The goal isn't gone; it's temporarily buried under the reaction. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"Keeping your goal visible prevents it from getting lost in the moment of frustration.", nextStep:"Write your current goal on a card. Read it before reacting to the next setback." },
    coachText:{ coachingDirection:"Inhibition is the primary constraint — flooding overwhelms coping before it can deploy. A good starting point is a concrete pause tool, while monitoring whether competence strain is eroding willingness to try again.", strengthsLeverage:"Goal clarity is intact. Recovery capacity exists when externally prompted — that's evidence the skill is there, gated by the emotional timing.", clinicalSummary:"Inhibition flooding post-setback gates access to WM-dependent coping strategies. Recovery occurs with external prompt, indicating coping capacity is present but access-blocked.", hypotheses:"Primary: Inhibition flooding gating coping deployment. Consider: Depression or anxiety amplifying emotional reactivity to setbacks. Consider: Learned helplessness from accumulated failure.", ruleOutChecklist:["Check for depression or anxiety that may be amplifying emotional reactivity","Rule out learned helplessness as primary driver — is the student losing belief in recovery?","Check medication timing — stimulant wear-off can amplify emotional flooding","Consider cultural expressions of resilience — community-based recovery strategies may not register on individual assessment"], ruleOutPrompt:"Resilience is complex — check these before focusing on inhibition alone:", scaffoldSequence:"A good starting point might be a concrete recovery tool — something like a goal card with 3 steps — so the student has something to grab when the emotional moment overwhelms the plan. In parallel, monitor the competence signal: does the student still believe recovery is possible? If not, address that belief before pushing resilience practice. If structured supports do not improve performance within 3 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the goal clarity and prompted-recovery capacity — show the student their resilience exists.\nGrowth Edge: Show the flooding-to-recovery pattern — make the timing gap visible.\nNext Step: Install a physical goal reminder for the next setback.", equityNote:"A student from a collectivist background may show resilience through community-based strategies this instrument doesn't capture. Low scores here might mean 'resilient in a different way,' not 'not resilient.'" } },
  { id:"adapt", abbr:"AD",  name:"Adaptability", pillar:"tic", score:44, tier:"watch",
    strategyType:"compensate_scaffold_monitor", strategyLabel:"Structured Compensation + Need Monitoring", efTier:2, arcState:"watch",
    studentText:{ strengthsLead:"You like having a plan — that's a genuine strength. You recover and adapt well once given a moment to process.", possiblePatterns:["You get stuck when plans change unexpectedly, especially under time pressure.","You adapt well once given a moment to process — the issue is timing, not flexibility."], insightBody:"Your adaptability challenge is about timing, not flexibility. You can shift perspectives — that capacity is there. But when plans change suddenly, the first reaction floods in before flexibility can engage. A brief pause is the bridge between the reaction and the response. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"A short pause before reacting gives your flexibility time to engage.", nextStep:"When plans change: one slow breath, name what's happening, then decide." },
    coachText:{ coachingDirection:"Dual EF constraint (Inh + CogFlex) — inhibition gets access to adequate cognitive flexibility. Establish compensation supports before expecting flexible behavior, while monitoring autonomy strain.", strengthsLeverage:"Planning capacity is strong. Flexibility exists when not overridden by impulse. Frame scaffolds as 'creating Plan B' rather than 'being more flexible.'", clinicalSummary:"CogFlex adequate but gated by inhibition — first reaction arrives before flexible thinking can engage. Dual constraint means compensation must address both the impulse and the cognitive load.", hypotheses:"Primary: Inhibition gating CogFlex deployment under surprise conditions. Consider: Anxiety-driven rigidity vs. EF-driven rigidity. Consider: Preference for predictability (strength in planning) being pathologized.", ruleOutChecklist:["Check whether anxiety is driving apparent rigidity vs. EF constraint","Rule out that preference for predictability is being pathologized — planning is a strength","Consider cultural context — some cultures value consistency and deliberation over rapid adaptation","Check whether language barriers create additional processing load during unexpected changes"], ruleOutPrompt:"Adaptability intersects with anxiety, culture, and preference — check these:", scaffoldSequence:"A good starting point might be a structured pause protocol — one breath, name the change, then choose. This addresses the inhibition gate. Pair with a Plan A/Plan B framework that leverages the student's planning strength. Monitor autonomy: does the student feel changes are imposed or collaborative? If structured supports do not improve performance within 4 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the planning strength and the post-pause flexibility — both are real.\nGrowth Edge: Show the timing pattern — where the reaction outpaces the adaptation.\nNext Step: Install the breath-name-decide protocol for the next unexpected change.", equityNote:"Adaptability norms vary by culture. Rapid, visible adaptation is valued in some Western professional contexts but not universally. A student who processes change internally before acting may appear rigid but is actually adapting deliberately." } },
  { id:"collab", abbr:"CO",  name:"Collaboration", pillar:"tic", score:72, tier:"clear",
    strategyType:"pure_skill_gap", strategyLabel:"Direct Skill Building", efTier:0, arcState:"clear",
    studentText:{ strengthsLead:"You work well with others and make space for different perspectives. That's a genuine interpersonal strength.", possiblePatterns:["You contribute meaningfully in groups and naturally include others.","You create inclusive group dynamics that help everyone participate."], insightBody:"Collaboration is a genuine strength. You contribute meaningfully in groups and naturally include others. This capacity can serve as a scaffold for building communication and initiative in group contexts. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"Use this strength to scaffold growth in communication and initiative within group settings.", nextStep:"Create a simple To Do / Doing / Done board for your next group project." },
    coachText:{ coachingDirection:"This student's collaboration is a genuine asset — use group contexts as the vehicle for building weaker interpersonal and self-directed skills.", strengthsLeverage:"Natural collaborator with inclusive instincts. This capacity creates natural coaching contexts for Communication and Initiative.", clinicalSummary:"No EF constraint on collaboration. High relatedness satisfaction supports group engagement.", hypotheses:"Primary: Strength — genuine collaborative capacity. Note: Social desirability bias possible on self-report.", ruleOutChecklist:["Check for social desirability bias on self-report measures","Verify that collaborative behavior extends across contexts, not just comfortable groups","Consider whether the student's collaborative role masks other skill gaps in group settings"], ruleOutPrompt:"This is a strength profile — verify and leverage:", scaffoldSequence:"Direct skill-building only. Use collaborative contexts as natural practice environments for Communication and Initiative growth. If structured supports do not improve performance within 2 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the collaborative patterns — inclusion, contribution, group facilitation.\nGrowth Edge: Show where collaboration can serve as a bridge to other skill growth.\nNext Step: Deploy collaborative strength in one structured group task.", equityNote:"Collaborative styles vary by culture. A student from a hierarchical culture may collaborate differently than expected in egalitarian group structures." } },
  { id:"net",  abbr:"NE",  name:"Networking", pillar:"nb", score:66, tier:"clear",
    strategyType:"skill_coaching", strategyLabel:"Direct Skill Coaching", efTier:0, arcState:"clear",
    studentText:{ strengthsLead:"You build strong 1:1 connections quickly — your rapport skills are genuine.", possiblePatterns:["You build strong rapport quickly in 1:1 settings.","You feel drained or lose your footing in larger networking events."], insightBody:"Your networking strength is in dyad rapport — you build trust quickly one-on-one. Larger settings create more load on working memory, which drains energy without reflecting your actual social skill. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"A simple conversation framework reduces energy in larger settings.", nextStep:"Before your next group event, write 2 questions you want to ask. Treat it as a series of 1:1s." },
    coachText:{ coachingDirection:"This student's dyad rapport is strong — the growth edge is extending that capacity into multi-person contexts with light structural support.", strengthsLeverage:"Exceptional 1:1 rapport. Frame networking events as 'serial 1:1 conversations' to leverage existing strength.", clinicalSummary:"WM increases load in multi-person settings but doesn't impair core social capacity. Quality is intact when load is managed.", hypotheses:"Primary: WM load in multi-person settings reducing performance. Consider: Social anxiety presenting as energy drain. Consider: Introversion (preference, not deficit) being pathologized.", ruleOutChecklist:["Check whether social anxiety is driving avoidance vs. WM load","Rule out introversion being pathologized — preference for 1:1 is legitimate","Consider cultural networking norms — some cultures value deep dyadic connection over broad networking"], ruleOutPrompt:"Networking challenges have multiple explanations — check these:", scaffoldSequence:"Light scaffolding: pre-event question preparation, reframing events as serial 1:1 conversations. Direct skill-building from there. If structured supports do not improve performance within 2 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the rapport quality in 1:1 settings — show the student their social strength.\nGrowth Edge: Show the 1:1 vs. group contrast — make the load pattern visible.\nNext Step: Reframe the next networking event as a series of three 1:1 conversations.", equityNote:"Networking norms vary dramatically by culture. A student who builds deep, few relationships is networking effectively — just differently than broad, shallow networking culture expects." } },
  { id:"rel",  abbr:"RB",  name:"Relationship Building", pillar:"nb", score:82, tier:"clear",
    strategyType:"pure_skill_gap", strategyLabel:"Direct Skill Building", efTier:0, arcState:"clear",
    studentText:{ strengthsLead:"You form deep, trusting connections and naturally seek support when things are hard. That capacity is a genuine asset.", possiblePatterns:["You form deep, trusting relationships relatively easily.","You seek connection and support when struggling — that's a strength, not a weakness."], insightBody:"Relationship building is one of your strongest capacities. You form deep, trusting connections and naturally seek support when things are hard. This is a primary lever for coaching and for scaffolding other growth areas. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"Your 1:1 connection ability is one of your best recovery tools.", nextStep:"Seek 1:1 time with a trusted tutor or mentor when you're stuck on a difficult task." },
    coachText:{ coachingDirection:"This student's relationship capacity is a primary coaching lever — the coaching relationship itself is the most powerful intervention available.", strengthsLeverage:"Exceptional relational capacity. The coach relationship is the primary lever — this student will engage deeply with a trusted advisor.", clinicalSummary:"No EF constraint. High relatedness satisfaction reinforces relational capacity.", hypotheses:"Primary: Strength — genuine relational satisfaction. Note: Check for over-dependence on relational validation.", ruleOutChecklist:["Check whether relational capacity extends across contexts or is context-dependent","Monitor for over-reliance on relational support as a coping strategy","Consider attachment style implications for the coaching relationship"], ruleOutPrompt:"This is a strength profile — leverage it thoughtfully:", scaffoldSequence:"Direct leverage. Use the coaching relationship as the primary intervention context. Deploy relational strength to scaffold other growth areas. If structured supports do not improve performance within 2 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the relational patterns — trust-building, support-seeking, connection-making.\nGrowth Edge: Show how relational strength can scaffold other skill development.\nNext Step: Deploy the coaching relationship as recovery scaffold.", equityNote:"Relational styles vary by culture. A student who shows relational strength through familial or community bonds may not demonstrate it in institutional contexts." } },
  { id:"soc",  abbr:"SA",  name:"Social Awareness", pillar:"nb", score:44, tier:"watch",
    strategyType:"compensate_scaffold_monitor", strategyLabel:"Structured Compensation + Need Monitoring", efTier:2, arcState:"watch",
    studentText:{ strengthsLead:"You care about how others feel — empathy is the foundation, and yours is genuine.", possiblePatterns:["You care deeply about others' feelings and social dynamics.","You misread social cues when emotionally activated or under time pressure."], insightBody:"Your social awareness challenge isn't about caring — you care deeply. It's about processing speed: when you need to both hold back your first reaction and shift your perspective at the same time, reading social cues in real time gets harder than it should be. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"A slight pause gives your social processing time to catch up with your caring.", nextStep:"In your next tense conversation, try a 3-second pause before responding." },
    coachText:{ coachingDirection:"Dual EF constraint (CogFlex + Inh) impairs real-time social cue processing — establish compensation for both domains while monitoring relatedness strain.", strengthsLeverage:"Empathy provides strong motivational foundation. The caring is genuine — the delivery mechanism needs support.", clinicalSummary:"CogFlex + Inhibition combined constraint impairs real-time cue processing. Empathic capacity is intact but expression is blocked under pressure. Negative synergy — each constraint worsens the other.", hypotheses:"Primary: CogFlex + Inh combined constraint on real-time social processing. Consider: Social anxiety amplifying cue-reading difficulties. Consider: Autism spectrum considerations — different social processing, not deficient.", ruleOutChecklist:["Consider autism spectrum — different social processing style, not deficit","Check whether social anxiety is driving apparent cue-reading difficulties","Check cultural context — social cue norms vary dramatically across cultures","Rule out that the student is code-switching between cultural frames, consuming cognitive resources"], ruleOutPrompt:"Social awareness involves cultural, neurological, and contextual factors — check all of these:", scaffoldSequence:"A good starting point might be a structured pause — 3 seconds before responding in tense situations. This addresses the inhibition gate. Pair with pre-briefing for high-stakes social situations to reduce cognitive load. In parallel, monitor relatedness: does the student feel connected enough to take social risks? If structured supports do not improve performance within 4 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the caring and empathic foundation — show the student their social motivation.\nGrowth Edge: Show where cue-reading breaks down under pressure — make the timing gap visible.\nNext Step: Install a 3-second pause in one recurring tense situation.", equityNote:"Social awareness norms vary dramatically across cultures. A student from a high-context culture may read social cues differently, not worse. Never attribute social awareness scores to character or social skill deficit without checking cultural context." } },
];

// EF dimensions (Lens 2)
const EF_SKILLS = [
  { id:"wm", abbr:"WM", name:"Working Memory", pillar:"ef", score:38, tier:"watch", gloss: EF_DIMS[0].gloss,
    studentText:{ strengthsLead:"Your thinking is strong when you can focus on one thing at a time — that processing quality is real.", possiblePatterns:["You perform well with focused, single-source tasks.","You get overloaded when managing multiple inputs simultaneously."], insightBody:"Working memory is about how much you can hold in mind at once. When the load is manageable, your processing quality is high. The constraint shows up when tasks require juggling multiple inputs simultaneously — external tools bridge that gap. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"External tools that hold information let your strengths come through.", nextStep:"Use a notepad to capture key points during your next complex task." },
    coachText:{ coachingDirection:"Core EF constraint affecting multiple downstream skills. Compensate with external aids to reveal processing quality.", strengthsLeverage:"Processing quality is high when load is managed. Surface this quality to build student confidence.", clinicalSummary:"WM below threshold for multi-source tasks. Affects Critical Thinking, Communication, Initiative, Networking.", hypotheses:"Primary: WM capacity limitation. Consider: Attention disorder. Consider: Sleep, nutrition, or stress factors reducing available WM.", ruleOutChecklist:["Check for attention disorder — WM constraint overlaps with ADHD presentation","Rule out sleep, nutrition, or stress as reducing available WM capacity","Check assessment artifact — was the testing environment noisy or distracting?"], ruleOutPrompt:"WM constraint has multiple explanations — check these:", scaffoldSequence:"Compensate first: external aids that hold information (notepads, templates, checklists). Accommodate: restructure tasks to reduce simultaneous demands. Strengthen: gradually increase load in supported environments. If structured supports do not improve performance within 3 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the processing quality in focused work — it's real.\nGrowth Edge: Show the single vs. multi-source contrast.\nNext Step: Install one external aid for the next complex task.", equityNote:"EF is a capacity measure, not an ability or intelligence measure. Frame as 'how much you can hold,' not 'how smart you are.'" } },
  { id:"ih", abbr:"IH", name:"Inhibition", pillar:"ef", score:25, tier:"blocker", gloss: EF_DIMS[1].gloss,
    studentText:{ strengthsLead:"Your quick reactions show engagement and responsiveness — you care about what's happening, and that shows.", possiblePatterns:["You respond quickly and are highly engaged in the moment.","You act before considering alternatives, especially under pressure or frustration."], insightBody:"Inhibition is about the gap between your first reaction and your best reaction. Your engagement is high — you respond quickly and care about what's happening. The growth edge is in creating a brief pause so your full judgment can catch up with your first impulse. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"A brief pause before acting gives your best judgment time to catch up.", nextStep:"Practice a 3-breath pause before responding to the next frustrating situation. Many students show this pattern — it responds well to the right support." },
    coachText:{ coachingDirection:"Primary blocker cascading across multiple skills. This student reacts fast — their first impulse arrives before their best judgment. That's the inhibition pattern showing up. A good starting point is installing a pause mechanism.", strengthsLeverage:"High engagement and responsiveness. Channel into structured tasks where quick reactions are appropriate.", clinicalSummary:"Inhibition below threshold. Flooding gates WM-dependent coping across Resilience, Adaptability, Initiative, Social Awareness, Critical Thinking. Primary cascade source in this profile.", hypotheses:"Primary: Inhibition capacity limitation — first reaction arrives before reflective processing. Consider: ADHD. Consider: Emotional regulation disorder. Consider: Trauma response amplifying reactivity.", ruleOutChecklist:["Check for ADHD — inhibition constraint is a core ADHD feature","Rule out emotional regulation disorder as primary driver","Consider trauma response — hypervigilance can present as inhibition deficit","Check cultural expression — some cultures value rapid, direct response","Check medication timing — stimulant wear-off can amplify impulsivity"], ruleOutPrompt:"Inhibition is the primary blocker in this profile — thorough rule-out is critical:", scaffoldSequence:"A good starting point might be a concrete pause tool — something physical like three breaths or a fidget object that creates temporal space between impulse and action. Environmental accommodations: reduce situations that demand rapid response until the pause is practiced. Then build toward internalized self-regulation through progressively more challenging contexts. If structured supports do not improve performance within 6 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the engagement and responsiveness — it's genuine, not a problem.\nGrowth Edge: Show the impulse-to-consequence pattern — make the timing gap visible.\nNext Step: Install one physical pause protocol.", equityNote:"Inhibition constraint is commonly misattributed as behavioral problem, defiance, or lack of respect. It is a timing issue, not a character issue. Black and brown students are disproportionately disciplined for impulsivity — ensure this pattern is framed as structural, not behavioral." } },
  { id:"cf", abbr:"CF", name:"Cognitive Flexibility", pillar:"ef", score:68, tier:"clear", gloss: EF_DIMS[2].gloss,
    studentText:{ strengthsLead:"You shift between ideas and approaches naturally — flexibility is one of your cognitive strengths.", possiblePatterns:["You shift perspectives easily and adapt when your first approach doesn't work.","You see problems from multiple angles without getting stuck on one view."], insightBody:"Cognitive flexibility — your ability to shift between ideas and approaches — is a genuine strength. It supports your creative problem solving and adaptability, and serves as a foundation for growth in other areas. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"This is one of your best cognitive assets. Keep building on it.", nextStep:"Practice stating someone's opposing position back to them before offering your own view." },
    coachText:{ coachingDirection:"CogFlex is an asset — leverage it as a foundation for growth in Creative Problem Solving, Adaptability, and Social Awareness.", strengthsLeverage:"Natural perspective-shifter. This capacity supports multiple skills — it's a genuine cognitive asset.", clinicalSummary:"Above threshold. No constraint. Supports CPS, Adaptability, and Social Awareness.", hypotheses:"Primary: Strength — genuine cognitive flexibility.", ruleOutChecklist:["Verify strength extends across contexts, not just comfortable domains","Check whether assessment captured range of flexibility expression"], ruleOutPrompt:"This is a strength — verify it:", scaffoldSequence:"Direct leverage. Use cognitive flexibility to support growth in other areas. If structured supports do not improve performance within 2 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the flexibility patterns — perspective-shifting, approach-switching.\nGrowth Edge: Show where flexibility can support other skill growth.\nNext Step: Deploy flexibility as a scaffold for one growth area.", equityNote:"Cognitive flexibility expression varies by context. A student who appears rigid in one domain may be highly flexible in another." } },
];

// ARC dimensions (Lens 3)
const ARC_SKILLS = [
  { id:"aut", abbr:"AU", name:"Autonomy", pillar:"arc", score:42, tier:"watch", gloss: ARC_DIMS[0].gloss,
    studentText:{ strengthsLead:"You want to make your own choices — that drive toward ownership is healthy and real.", possiblePatterns:["You value independence and want ownership of your path.","You disengage when you feel controlled or when choices are made for you."], insightBody:"Autonomy is your sense of choice and control. Yours is partially unmet right now — not because you lack the drive, but because environments or structures may be limiting your sense of agency. Small, genuine choices rebuild that sense of ownership. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"Small choices in routines feed your sense of ownership and control.", nextStep:"Identify one genuine choice you can make about your next assignment — topic, format, or timing." },
    coachText:{ coachingDirection:"Autonomy need is strained but not in crisis. Create coaching conditions that actively offer choice — topic, format, timing, approach. If engagement dips, check this need before attributing it to the skill gap.", strengthsLeverage:"Strong drive toward independence. Choice-offering increases engagement meaningfully.", clinicalSummary:"Partially unmet. Contributing to motivation patterns across Initiative and Resilience.", hypotheses:"Primary: Environmental control excess — structures limiting agency. Consider: Developmental stage transition. Consider: Learned passivity from over-structured settings.", ruleOutChecklist:["Check environmental control — is the student in over-structured contexts?","Rule out developmental stage effects","Consider cultural norms around autonomy expression — autonomy is not equally valued across cultures","Check whether language around 'choice' resonates or feels foreign"], ruleOutPrompt:"Autonomy strain has environmental and cultural dimensions — check both:", scaffoldSequence:"Build choice architecture into coaching: offer genuine choices about what, when, and how. Move toward self-directed goals. Support independence as capacity grows. If structured supports do not improve performance within 3 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the drive toward ownership — it's genuine.\nGrowth Edge: Show where choice is missing and how it affects engagement.\nNext Step: Install one choice point in the next coaching session.", equityNote:"Autonomy is a Western-emphasized value. A student from a collectivist culture may not frame their motivation in terms of individual choice — that doesn't mean autonomy is irrelevant, but the expression may look different." } },
  { id:"comp", abbr:"CP2", name:"Competence", pillar:"arc", score:40, tier:"watch", gloss: ARC_DIMS[1].gloss,
    studentText:{ strengthsLead:"You want to feel effective — that matters, and the frustration you may be feeling is a signal, not a verdict.", possiblePatterns:["You question whether your effort actually leads to results.","You persist longer when you can see concrete evidence of progress."], insightBody:"Competence is your sense of effectiveness — whether effort leads to results. Yours is strained right now, which means repeated experiences may have made it harder to trust that trying will pay off. That feeling is real, but it's about experience, not ability. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"Concrete evidence of progress rebuilds trust in your own effectiveness.", nextStep:"After your next completed task, write one sentence about what went well and why." },
    coachText:{ coachingDirection:"Competence need is strained — the student doesn't fully trust that effort leads to results. Create early wins that rebuild the effort-to-outcome connection. Monitor this signal closely alongside Initiative and Resilience.", strengthsLeverage:"Persistence exists when progress evidence is visible. Create short feedback loops.", clinicalSummary:"Competence partially unmet. Contributing to Initiative and Resilience challenges — reduced willingness to start or recover when effectiveness belief is low.", hypotheses:"Primary: Accumulated failure experiences eroding effectiveness belief. Consider: Assessment contexts that don't match student's actual competence domains. Consider: Mismatch between student's strengths and institutional reward structures.", ruleOutChecklist:["Check whether the student has competence evidence in domains the assessment doesn't measure","Rule out that institutional reward structures are misaligned with student strengths","Consider whether imposter syndrome dynamics are at play","Check cultural context — competence may be collectively rather than individually experienced"], ruleOutPrompt:"Competence frustration has experiential roots — understand the history:", scaffoldSequence:"Create early wins first — tasks with visible, short-cycle outcomes that rebuild effectiveness belief. Pair with explicit progress feedback. Move toward longer-cycle tasks as trust rebuilds. If structured supports do not improve performance within 3 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name concrete evidence of effectiveness the student may not see.\nGrowth Edge: Show the effort-to-outcome pattern — make progress visible.\nNext Step: Install one progress-tracking mechanism.", equityNote:"Students from marginalized backgrounds may have had their competence systematically underrecognized. Low competence satisfaction may reflect accurate assessment of institutional barriers, not personal limitation." } },
  { id:"relat", abbr:"RL", name:"Relatedness", pillar:"arc", score:78, tier:"clear", gloss: ARC_DIMS[2].gloss,
    studentText:{ strengthsLead:"You feel connected to people around you and maintain a strong support network. That's a real asset.", possiblePatterns:["You maintain strong bonds with people around you.","You naturally seek and give support in your relationships."], insightBody:"Relatedness is your sense of connection and belonging. Yours is well-satisfied — you have a strong support network and seek connection naturally. This is a primary asset for coaching and for supporting growth in other areas. These are coaching signals — supports help your strengths show up more consistently.", growthEdge:"Your relationships are your best support system — lean on them when things get hard.", nextStep:"Reach out to someone you trust when you're struggling with a difficult task or decision." },
    coachText:{ coachingDirection:"Relatedness is well-satisfied — this is a primary coaching asset. The coaching relationship itself can be a powerful intervention lever.", strengthsLeverage:"High satisfaction. Support network intact. Relationship is a primary intervention channel.", clinicalSummary:"Well-satisfied. Reinforces Empathy, Collaboration, Relationship Building, and Networking.", hypotheses:"Primary: Strength — genuine relational satisfaction. Note: Check for over-dependence on relational validation.", ruleOutChecklist:["Monitor for over-dependence on external validation through relationships","Check whether relational strength extends across contexts","Consider whether the student's support network is reciprocal and sustainable"], ruleOutPrompt:"This is a strength — ensure it's being tolerated:", scaffoldSequence:"Direct leverage. Anchor coaching in the relational context. Deploy support network as recovery resource. If structured supports do not improve performance within 2 weeks, revisit all hypotheses.", feedbackStructure:"What's Working: Name the relational patterns — connection, support-seeking, bond-maintenance.\nGrowth Edge: Show how relational strength can scaffold other growth.\nNext Step: Deploy the support network for one specific challenge.", equityNote:"Relational expression varies by culture. A student whose relatedness is grounded in family or community rather than institutional peers may not show it in campus-based assessments." } },
];

// All skills combined for radar
const ALL_SKILLS = [...DURABLE_SKILLS, ...EF_SKILLS, ...ARC_SKILLS];
const PM = {}; ALL_SKILLS.forEach(p => PM[p.id] = p);

// Connections map (cascade relationships)
const CONNECTIONS = {
  ih:    { affects: ["resil","adapt","init","soc","crit"], note: "Primary blocker — inhibition flooding cascades into regulation-dependent skills" },
  wm:    { affects: ["crit","comm","init","net","aut","comp"], note: "WM constraint reduces multi-source processing across skills" },
  cf:    { affects: ["cps","adapt","soc"], note: "CogFlex supports perspective-shifting skills — asset here" },
  relat: { affects: ["emp","collab","rel","net"], note: "Relatedness satisfaction reinforces social strengths" },
  aut:   { affects: ["init","resil"], note: "Unmet autonomy reduces self-directed action" },
  comp:  { affects: ["init","resil","adapt"], note: "Unmet competence undermines persistence after setback" },
};

/* ─── Shared UI Elements ─── */
const RedFlagIcon = ({ size = 12 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill={C.blocker} stroke={C.blocker} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" style={{ flexShrink: 0 }}>
    <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" />
    <line x1="4" y1="22" x2="4" y2="15" />
  </svg>
);

/* ─── View Modes ─── */
const VIEW_MODES = [
  { id: "profile", label: "My Profile", desc: "Guided walkthrough of your results" },
  { id: "full",    label: "Full Picture", desc: "Interactive chart with full detail" },
  { id: "explore", label: "Explore", desc: "Browse all skills as cards" },
];

/* ─── Keyboard nav helper for tab groups ─── */
const useTabKeyboard = (items, currentId, onSelect) => {
  return useCallback((e) => {
    const idx = items.findIndex(i => (i.id || i.k) === currentId);
    let next = idx;
    if (e.key === "ArrowRight" || e.key === "ArrowDown") { next = (idx + 1) % items.length; e.preventDefault(); }
    else if (e.key === "ArrowLeft" || e.key === "ArrowUp") { next = (idx - 1 + items.length) % items.length; e.preventDefault(); }
    else if (e.key === "Home") { next = 0; e.preventDefault(); }
    else if (e.key === "End") { next = items.length - 1; e.preventDefault(); }
    else return;
    const nextId = items[next].id || items[next].k;
    onSelect(nextId);
    const parent = e.currentTarget;
    const buttons = parent.querySelectorAll('[role="tab"]');
    if (buttons[next]) buttons[next].focus();
  }, [items, currentId, onSelect]);
};

/* ═════════════════════════════════════════════════
   GEOMETRY (from v9)
   ═════════════════════════════════════════════════ */
const DEG = Math.PI / 180;
const polar = (cx,cy,r,d) => ({x:cx+r*Math.cos((d-90)*DEG),y:cy+r*Math.sin((d-90)*DEG)});

const wedgePath = (cx,cy,r0,r1,startDeg,endDeg) => {
  const gap=1.0;
  const s=startDeg+gap,e=endDeg-gap;
  const i1=polar(cx,cy,r0,s),i2=polar(cx,cy,r0,e),o1=polar(cx,cy,r1,s),o2=polar(cx,cy,r1,e);
  const lg=(e-s)>180?1:0;
  return `M ${i1.x} ${i1.y} L ${o1.x} ${o1.y} A ${r1} ${r1} 0 ${lg} 1 ${o2.x} ${o2.y} L ${i2.x} ${i2.y} A ${r0} ${r0} 0 ${lg} 0 ${i1.x} ${i1.y} Z`;
};

const arcPathFn = (cx,cy,r,startDeg,endDeg,reverse) => {
  if (reverse) {
    const s=polar(cx,cy,r,endDeg),e=polar(cx,cy,r,startDeg);
    const lg=(endDeg-startDeg)>180?1:0;
    return `M ${s.x} ${s.y} A ${r} ${r} 0 ${lg} 0 ${e.x} ${e.y}`;
  }
  const s=polar(cx,cy,r,startDeg),e=polar(cx,cy,r,endDeg);
  const lg=(endDeg-startDeg)>180?1:0;
  return `M ${s.x} ${s.y} A ${r} ${r} 0 ${lg} 1 ${e.x} ${e.y}`;
};

/* ═════════════════════════════════════════════════
   SHARED COMPONENTS
   ═════════════════════════════════════════════════ */

const TierBadge = ({ tier, size = "sm" }) => {
  const tierInfo = TM[tier];
  const pad = size === "sm" ? "2px 8px" : "4px 12px";
  const fs = size === "sm" ? T.xs : T.sm;
  return (
    <span style={{ display:"inline-flex", alignItems:"center", gap: 4, padding:pad, borderRadius:20, background:tierInfo.bg, border:`1.5px solid ${tierInfo.color}30`, fontSize:fs, fontWeight:700, color:tierInfo.dark, whiteSpace:"nowrap" }}>
      {tier === "blocker" && <RedFlagIcon size={size === "sm" ? 10 : 12} />}
      {tierInfo.label}
    </span>
  );
};

const ScoreBar = ({ score, tier, width = 120 }) => {
  const tierInfo = TM[tier];
  return (
    <div style={{ display:"flex", alignItems:"center", gap:8 }}>
      <div style={{ width, height:6, borderRadius:3, background:`${C.border}` }}>
        <div style={{ width:`${score}%`, height:"100%", borderRadius:3, background:tierInfo.color, opacity:0.7, transition:"width 0.3s ease" }} />
      </div>
      <span style={{ fontSize:T.sm, fontWeight:800, color:tierInfo.color, minWidth:24 }}>{score}</span>
    </div>
  );
};

const StudentDetail = ({ skill }) => {
  const st = skill.studentText;
  const conn = CONNECTIONS[skill.id];
  return (
    <div style={{ padding:`${S.lg}px 0`, display:"flex", flexDirection:"column", gap:S.lg, animation:"fadeIn 0.2s ease" }}>
      <div style={{ padding:S.md, borderRadius:8, borderLeft:`3px solid ${C.clear}`, background:C.clearBg }}>
        <div style={{ fontSize:T.xs, fontWeight:700, color:C.clearDark, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:4 }}>What's Working</div>
        <p style={{ margin:0, fontSize:T.base, color:C.text, lineHeight:1.55 }}>{st.strengthsLead}</p>
      </div>
      <div style={{ padding:S.md, borderRadius:8, background:`${C.border}44` }}>
        <div style={{ fontSize:T.xs, fontWeight:700, color:C.mid, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:8 }}>You may notice…</div>
        {st.possiblePatterns.map((pat, i) => (
          <p key={i} style={{ margin:i>0?"8px 0 0":0, fontSize:T.sm, color:C.text, lineHeight:1.5, paddingLeft:S.md }}>
            <span style={{ color:C.light, marginRight:6 }}>▸</span>{pat}
          </p>
        ))}
      </div>
      <div>
        <div style={{ fontSize:T.xs, fontWeight:700, color:C.mid, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:6 }}>What's Going On</div>
        <p style={{ margin:0, fontSize:T.base, color:C.text, lineHeight:1.6 }}>{st.insightBody}</p>
      </div>
      <div>
        <div style={{ fontSize:T.xs, fontWeight:700, color:C.mid, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:6 }}>Where to Grow</div>
        <p style={{ margin:0, fontSize:T.base, color:C.text, lineHeight:1.55 }}>{st.growthEdge}</p>
      </div>
      <div style={{ padding:S.md, borderRadius:8, borderLeft:`3px solid ${C.watch}`, background:C.watchBg }}>
        <div style={{ fontSize:T.xs, fontWeight:700, color:C.watchDark, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:4 }}>One Place to Start</div>
        <p style={{ margin:0, fontSize:T.base, color:C.text, lineHeight:1.55 }}>{st.nextStep}</p>
      </div>
      {conn && (
        <div style={{ padding:S.md, borderRadius:8, background:`${C.purple}08`, border:`1px solid ${C.purple}20` }}>
          <div style={{ fontSize:T.xs, fontWeight:700, color:C.purpleDark, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:6 }}>Connected Skills</div>
          <p style={{ margin:`0 0 ${S.sm}px`, fontSize:T.sm, color:C.mid, lineHeight:1.5, fontStyle:"italic" }}>{conn.note}</p>
          <div style={{ display:"flex", flexWrap:"wrap", gap:S.sm }}>
            {conn.affects.map(id => {
              const target = PM[id];
              if (!target) return null;
              const gr = GM[target.pillar];
              return (
                <span key={id} style={{ display:"inline-flex", alignItems:"center", gap:4, padding:`${S.xs}px ${S.sm}px`, borderRadius:S.sm, background:TM[target.tier].bg, border:`1.5px solid ${TM[target.tier].color}30` }}>
                  {target.tier === "blocker" ? <div style={{ width:8, height:8, borderRadius:2, background:C.blocker, flexShrink:0 }} /> : <span style={{ width:8, height:8, borderRadius:2, background:gr?.color || C.mid, flexShrink:0 }} />}
                  <span style={{ fontSize:T.sm, fontWeight:600, color:C.text }}>{target.name}</span>
                  <span style={{ fontSize:T.sm, fontWeight:800, color:TM[target.tier].color }}>{target.score}</span>
                </span>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
};

/* Mini graphical indicator for the domain header — updated to be larger and placed on the right */
const DomainSummaryViz = ({ skills }) => {
  return (
    <div style={{ display: "flex", gap: 3, height: 6, width: 80, borderRadius: 3, overflow: "hidden", background: C.border }}>
      {skills.map((s, i) => (
        <div key={i} style={{ flex: 1, background: TM[s.tier].color, opacity: 0.9, borderRadius: 1 }} />
      ))}
    </div>
  );
};

/* Skill card for My Profile + Explore views */
const SkillCard = ({ skill, isExpanded, onToggle }) => {
  const gr = GM[skill.pillar];
  const tierInfo = TM[skill.tier];
  return (
    <div style={{ background:C.card, borderRadius:10, border:`1px solid ${isExpanded?tierInfo.color+'40':C.border}`, overflow:"hidden", transition:"all 0.15s", boxShadow: isExpanded ? `0 2px 12px -3px ${tierInfo.color}20` : "none" }}>
      <div onClick={onToggle} style={{ display:"flex", alignItems:"center", gap:S.md, padding:`${S.md}px ${S.lg}px`, cursor:"pointer", userSelect:"none" }}>
        <div style={{ display: "flex", alignItems: "center", justifyContent: "center", width: 14, height: 14, flexShrink: 0 }}>
          {skill.tier === "blocker" ? <div style={{ width:10, height:10, borderRadius:2, background:C.blocker }} /> : <div style={{ width:10, height:10, borderRadius:2, background:gr?.color || C.mid }} />}
        </div>
        <div style={{ flex:1, minWidth:0 }}>
          <div style={{ display:"flex", alignItems:"center", gap:S.sm, flexWrap:"wrap" }}>
            <span style={{ fontSize:T.base, fontWeight:700, color:C.text }}>{skill.name}</span>
            <TierBadge tier={skill.tier} />
          </div>
          <p style={{ margin:`4px 0 0`, fontSize:T.sm, color:C.mid, lineHeight:1.4 }}>{skill.studentText.strengthsLead}</p>
        </div>
        <ScoreBar score={skill.score} tier={skill.tier} />
        <span style={{ fontSize:T.sm, color:C.light, transform:isExpanded?"rotate(180deg)":"rotate(0)", transition:"transform 0.2s" }}>▾</span>
      </div>
      {isExpanded && (
        <div style={{ padding:`0 ${S.lg}px ${S.lg}px`, borderTop:`1px solid ${C.border}` }}>
          <StudentDetail skill={skill} />
        </div>
      )}
    </div>
  );
};

/* ═════════════════════════════════════════════════
   VIEW 1: MY PROFILE (Student Progressive Disclosure)
   ═════════════════════════════════════════════════ */
const tierDotColor = tier => tier === "blocker" ? C.blocker : tier === "watch" ? C.watch : C.clear;
const tierDotSize = tier => tier === "blocker" ? 10 : 8;

const TierDotStrip = ({ skills }) => (
  <div style={{ display:"flex", alignItems:"center", gap:4 }}>
    {skills.map(s => (
      <div key={s.id} title={`${s.name}: ${s.tier}`} style={{ display: "flex", alignItems: "center", justifyContent: "center", width: 12, height: 12 }}>
        <div style={{
          width: tierDotSize(s.tier), height: tierDotSize(s.tier),
          borderRadius: s.tier === "blocker" ? 2 : "50%",
          background: tierDotColor(s.tier),
          flexShrink: 0,
        }} />
      </div>
    ))}
  </div>
);

const BlockerFlag = () => (
  <div style={{
    display:"flex", alignItems:"center", justifyContent: "center",
    background: C.blocker + "18", border:`1px solid ${C.blocker}50`,
    borderRadius:6, padding:"4px",
  }}>
    <div style={{ width:10, height:10, borderRadius:2, background:C.blocker }} />
  </div>
);

const DomainAccordion = ({ id, name, tagline, accentColor, darkColor, skills, expandedId, onToggle, isOpen, onToggleSection }) => {
  const tierOrder = { blocker: 0, watch: 1, clear: 2 };
  const sorted = [...skills].sort((a,b) => tierOrder[a.tier] - tierOrder[b.tier]);
  const blockerCount = sorted.filter(s => s.tier === "blocker").length;

  return (
    <div style={{
      background: C.card, borderRadius:12, overflow:"hidden", transition:"all 0.15s",
      border: `1px solid ${blockerCount > 0 && !isOpen ? C.blocker + "40" : C.border}`,
    }}>
      <div
        onClick={onToggleSection}
        style={{
          display:"flex", alignItems:"center", gap:S.md,
          padding:`${S.md}px ${S.lg}px`, cursor:"pointer", userSelect:"none",
        }}
      >
        <div style={{ flex:1, minWidth:0 }}>
          <div style={{ display:"flex", alignItems:"center", gap:S.md, justifyContent: "space-between", paddingRight: S.sm }}>
            <div style={{ display: "flex", alignItems: "center", gap: S.sm, flex: 1 }}>
              <h3 style={{ fontSize:T.sm, fontWeight:800, color:darkColor, margin:0 }}>{name}</h3>
              {blockerCount > 0 && <BlockerFlag />}
            </div>
            
            {/* Viz moved to the right of the text and made larger */}
            {!isOpen && (
              <div style={{ display:"flex", alignItems:"center", gap:S.lg }}>
                 <DomainSummaryViz skills={skills} />
                 <span style={{ fontSize:T.xxs, color:C.light, width: 45, textAlign: "right" }}>{sorted.length} skills</span>
              </div>
            )}
          </div>
          {isOpen && tagline && (
            <p style={{ fontSize:T.xs, color:C.mid, margin:`4px 0 0` }}>{tagline}</p>
          )}
        </div>
        <span style={{
          fontSize:T.sm, color:C.light, flexShrink:0,
          transform: isOpen ? "rotate(180deg)" : "rotate(0)", transition:"transform 0.2s",
        }}>▾</span>
      </div>

      {isOpen && (
        <div style={{ padding:`0 ${S.lg}px ${S.lg}px`, display:"flex", flexDirection:"column", gap:S.sm }}>
          {sorted.map(skill => (
            <SkillCard key={skill.id} skill={skill} isExpanded={expandedId===skill.id} onToggle={() => onToggle(skill.id)} />
          ))}
        </div>
      )}
    </div>
  );
};

const MyProfileView = ({ expandedId, onToggle }) => {
  const blockers = DURABLE_SKILLS.filter(s => s.tier === "blocker");
  const topStrength = DURABLE_SKILLS.filter(s => s.tier === "clear").sort((a,b) => b.score - a.score)[0];
  const [openSections, setOpenSections] = useState(new Set());
  const toggleSection = id => setOpenSections(prev => {
    const next = new Set(prev);
    next.has(id) ? next.delete(id) : next.add(id);
    return next;
  });

  const summaryLines = [];
  if (topStrength) summaryLines.push(topStrength.studentText.strengthsLead);
  if (blockers.length > 0) {
    summaryLines.push(`Your highest-leverage growth area is ${blockers[0].name} — ${blockers[0].studentText.growthEdge.charAt(0).toLowerCase() + blockers[0].studentText.growthEdge.slice(1)}`);
  }

  const allBlockers = ALL_SKILLS.filter(s => s.tier === "blocker");

  return (
    <div style={{ display:"flex", flexDirection:"column", gap:S.xxl }}>
      {/* Section A: Summary Card */}
      <div style={{ background:C.card, borderRadius:14, border:`1px solid ${C.border}`, padding:S.xxl, boxShadow:"0 2px 12px -3px rgba(0,0,0,0.06)" }}>
        <h2 style={{ fontSize:T.xl, fontWeight:800, color:C.text, margin:0 }}>Carlos, here's what stood out.</h2>
        <div style={{ marginTop:S.md, display:"flex", flexDirection:"column", gap:S.sm }}>
          {summaryLines.map((line, i) => (
            <p key={i} style={{ margin:0, fontSize:T.base, color:C.text, lineHeight:1.6 }}>{line}</p>
          ))}
        </div>
        {allBlockers.length > 0 && (
          <div style={{ display:"flex", alignItems:"center", gap: 8, marginTop:S.md }}>
             <RedFlagIcon size={16} />
             <p style={{ margin:0, fontSize:T.sm, color:C.blocker, fontWeight:600 }}>
              Look for the red dots below — {allBlockers.length === 1 ? "1 area needs" : `${allBlockers.length} areas need`} your attention.
            </p>
          </div>
        )}
      </div>

      {/* Main Grid: 2-Column Scannable Layout */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(450px, 1fr))", gap: S.xxl }}>
        
        {/* Column 1: Action (Durable Skills) */}
        <div style={{ display:"flex", flexDirection:"column", gap:S.lg }}>
          <div style={{ borderBottom: `1px solid ${C.border}`, paddingBottom: S.sm }}>
            <h2 style={{ fontSize:T.lg, fontWeight:800, color:C.text, margin:0 }}>Durable Skills</h2>
            <p style={{ fontSize: T.xs, color: C.mid, margin: `4px 0 0` }}>The skills you use every day in school and work.</p>
          </div>
          <div style={{ display:"flex", flexDirection:"column", gap:S.sm }}>
            {PILLARS.map(pillar => {
              const skills = DURABLE_SKILLS.filter(s => s.pillar === pillar.id);
              return (
                <DomainAccordion
                  key={pillar.id} id={pillar.id} name={pillar.name} tagline={pillar.tagline}
                  accentColor={pillar.color} darkColor={pillar.dark}
                  skills={skills} expandedId={expandedId} onToggle={onToggle}
                  isOpen={openSections.has(pillar.id)}
                  onToggleSection={() => toggleSection(pillar.id)}
                />
              );
            })}
          </div>
        </div>

        {/* Column 2: Roots (What's Underneath) */}
        <div style={{ display:"flex", flexDirection:"column", gap:S.lg }}>
          <div style={{ borderBottom: `1px solid ${C.border}`, paddingBottom: S.sm }}>
            <h2 style={{ fontSize:T.lg, fontWeight:800, color:C.text, margin:0 }}>What's Underneath</h2>
            <p style={{ fontSize: T.xs, color: C.mid, margin: `4px 0 0` }}>The cognitive foundations and needs that shape your skills.</p>
          </div>
          <div style={{ display:"flex", flexDirection:"column", gap:S.sm }}>
            <DomainAccordion
              id="ef" name="Executive Function"
              tagline="How your mind processes, holds, and manages information"
              accentColor={C.purple} darkColor={C.purpleDark}
              skills={EF_SKILLS} expandedId={expandedId} onToggle={onToggle}
              isOpen={openSections.has("ef")}
              onToggleSection={() => toggleSection("ef")}
            />
            <DomainAccordion
              id="arc" name="Your Core Needs"
              tagline="Whether your sense of choice, effectiveness, and connection are being met"
              accentColor={C.pink} darkColor={C.pinkDark}
              skills={ARC_SKILLS} expandedId={expandedId} onToggle={onToggle}
              isOpen={openSections.has("arc")}
              onToggleSection={() => toggleSection("arc")}
            />
          </div>
        </div>
      </div>
    </div>
  );
};

/* ═════════════════════════════════════════════════
   VIEW 2: FULL PICTURE (Coach Radar + Sidebar + Drawer)
   ═════════════════════════════════════════════════ */
const fpInitial = {
  selectedId: null, hoveredId: null, keyView: "priority",
  activeTiers: new Set(), activeDomains: new Set(),
  drawerTab: "student", toast: null,
};
const toggleInSet = (set, id) => { const n = new Set(set); n.has(id)?n.delete(id):n.add(id); return n; };
function fpReducer(state, action) {
  switch (action.type) {
    case "SELECT_PETAL": return { ...state, selectedId: action.id === state.selectedId ? null : action.id, drawerTab: "student" };
    case "HOVER_PETAL":  return { ...state, hoveredId: action.id };
    case "SET_KEY_VIEW": return { ...state, keyView: action.view };
    case "TOGGLE_TIER":  return { ...state, activeTiers: toggleInSet(state.activeTiers, action.id) };
    case "TOGGLE_DOMAIN":return { ...state, activeDomains: toggleInSet(state.activeDomains, action.id) };
    case "SET_DRAWER_TAB": return { ...state, drawerTab: action.tab };
    case "SET_TOAST":    return { ...state, toast: action.toast };
    case "CLOSE_DRAWER": return { ...state, selectedId: null };
    default: return state;
  }
}

const FullPictureView = () => {
  const [state, dispatch] = useReducer(fpReducer, fpInitial);
  const { selectedId, hoveredId, keyView, activeTiers, activeDomains, drawerTab, toast } = state;
  const toastTimer = useRef(null);

  const petals = ALL_SKILLS;

  const toggleTier = (tid) => dispatch({ type:"TOGGLE_TIER", id:tid });
  const toggleDomain = (gid) => dispatch({ type:"TOGGLE_DOMAIN", id:gid });

  const showToast = useCallback((skill) => {
    if (toastTimer.current) clearTimeout(toastTimer.current);
    const gr = GM[skill.pillar];
    const tierInfo = TM[skill.tier];
    dispatch({ type:"SET_TOAST", toast:{ name:skill.name, score:skill.score, tierLabel:tierInfo.label, color:tierInfo.color, domainColor:gr?.color, gloss:skill.gloss||null, cta:"Click for details" } });
    toastTimer.current = setTimeout(() => dispatch({ type:"SET_TOAST", toast:null }), 3000);
  }, []);

  const clickPetal = (id) => dispatch({ type:"SELECT_PETAL", id });
  const hoverPetal = (id) => {
    dispatch({ type:"HOVER_PETAL", id });
    if (id) {
      const sk = PM[id];
      if (sk) showToast(sk);
    } else {
      if (toastTimer.current) clearTimeout(toastTimer.current);
      toastTimer.current = setTimeout(() => { dispatch({ type:"SET_TOAST", toast:null }); }, 150);
    }
  };

  const sel = selectedId ? PM[selectedId] : null;

  return (
    <div>
      <div style={{ background:C.card, borderRadius:10, border:`1px solid ${C.border}`, padding:`${S.md}px ${S.lg}px`, marginBottom:S.lg }}>
        <p style={{ margin:0, fontSize:T.sm, color:C.mid, lineHeight:1.5 }}>
          <strong style={{ color:C.text }}>Click any skill</strong> for direction, competing hypotheses, rule-out checklist, coaching sequence, feedback frame, equity check, and connected skill cascade. Use the sidebar to filter by priority tier or domain. Coach Notes tab provides full clinical interpretation.
        </p>
      </div>

      <div style={{ display:"grid", gridTemplateColumns:"310px 1fr", gap:S.lg, alignItems:"start" }}>
        <div style={{ position:"sticky", top:10, maxHeight:"calc(100vh - 36px)", overflowY:"auto" }}>
          <div style={{ padding:"8px 12px", marginBottom:8, borderRadius:8, background:C.card, border:`1px solid ${C.border}`, textAlign:"center" }}>
            <p style={{ margin:0, fontSize:T.xs, fontWeight:600, color:C.mid, fontStyle:"italic", lineHeight:1.4 }}>These scores are a snapshot — where you are now, not where you'll stay.</p>
          </div>
          <div style={{ display:"flex", background:C.card, borderRadius:10, border:`1px solid ${C.border}`, marginBottom:8, overflow:"hidden" }}>
            {[{k:"priority",l:"By Priority"},{k:"domain",l:"By Domain"}].map(v => (
              <button key={v.k} onClick={() => dispatch({type:"SET_KEY_VIEW",view:v.k})} style={{ flex:1, padding:"0.5rem", border:"none", cursor:"pointer", fontFamily:"inherit", background:keyView===v.k?C.text:"transparent", color:keyView===v.k?"#fff":C.mid, fontWeight:keyView===v.k?800:600, fontSize:T.sm, transition:"all 0.15s" }}>{v.l}</button>
            ))}
          </div>
          {keyView === "priority" ? (
            <SidebarPriority activeTiers={activeTiers} selectedId={selectedId} hoveredId={hoveredId} onToggleTier={toggleTier} onClickItem={clickPetal} onHoverItem={hoverPetal} />
          ) : (
            <SidebarDomain activeDomains={activeDomains} selectedId={selectedId} hoveredId={hoveredId} onToggleDomain={toggleDomain} onClickItem={clickPetal} onHoverItem={hoverPetal} />
          )}
        </div>

        <div>
          <div style={{ background:C.card, borderRadius:14, border:`1px solid ${C.border}`, padding:S.sm, position:"relative" }}>
            <CoachRadar petals={petals} activeTiers={activeTiers} activeDomains={activeDomains} selectedId={selectedId} hoveredId={hoveredId} onClickPetal={clickPetal} onHoverPetal={hoverPetal} onToggleDomain={toggleDomain} />
            {toast && (
              <div style={{ position:"absolute", top:16, left:"50%", transform:"translateX(-50%)", display:"inline-flex", flexDirection:"column", alignItems:"center", gap:2, padding:"10px 20px", borderRadius:16, background:C.card, border:`2px solid ${toast.color}`, boxShadow:`0 4px 16px -2px ${toast.color}30`, animation:"fadeIn 0.2s ease", zIndex:10, maxWidth:320, pointerEvents:"none" }}>
                <div style={{ display:"flex", alignItems:"center", gap:8 }}>
                  {toast.domainColor && <div style={{ width:10, height:10, borderRadius:2, background:toast.domainColor }} />}
                  <span style={{ fontSize:T.sm, fontWeight:800, color:C.text }}>{toast.name}</span>
                  <span style={{ fontSize:T.base, fontWeight:900, color:toast.color }}>{toast.score}</span>
                  <span style={{ fontSize:T.xs, fontWeight:700, color:toast.color }}>{toast.tierLabel}</span>
                </div>
                {toast.gloss && <span style={{ fontSize:T.xs, color:C.mid, textAlign:"center" }}>{toast.gloss}</span>}
                {toast.cta && <span style={{ fontSize:"0.6rem", color:C.light }}>{toast.cta}</span>}
              </div>
            )}
          </div>
          <div style={{ background:C.card, borderRadius:12, border:`1px solid ${C.border}`, padding:`${S.sm}px ${S.md}px`, marginTop:S.sm }}>
            <div style={{ display:"flex", justifyContent:"center", gap:5, flexWrap:"wrap" }}>
              {GROUPS.map(g => {
                const active = activeDomains.has(g.id);
                return (
                  <button key={g.id} onClick={() => toggleDomain(g.id)} style={{ display:"inline-flex", alignItems:"center", gap:5, padding:"4px 10px", borderRadius:20, cursor:"pointer", border:active?`2px solid ${g.color}`:`1.5px solid ${C.border}`, background:active?`${g.light}44`:C.bg, transition:"all 0.15s", fontFamily:"inherit", userSelect:"none" }}>
                    <div style={{ width:9, height:9, borderRadius:"50%", background:g.color, opacity:active?1:0.5 }} />
                    <span style={{ fontSize:T.xs, fontWeight:active?800:600, color:active?g.dark:C.mid, whiteSpace:"nowrap" }}>{g.name}</span>
                  </button>
                );
              })}
            </div>
          </div>
        </div>
      </div>

      {sel && (
        <CoachDrawer skill={sel} tab={drawerTab} setTab={(tab) => dispatch({type:"SET_DRAWER_TAB",tab})} onClose={() => dispatch({type:"CLOSE_DRAWER"})} />
      )}
    </div>
  );
};

const CoachRadar = ({ petals, activeTiers, activeDomains, selectedId, hoveredId, onClickPetal, onHoverPetal, onToggleDomain }) => {
  const Sz = 780, cx = Sz/2, cy = Sz/2, R0 = 18, R1 = 280;
  const N = petals.length, step = 360/N;
  const sR = useCallback(s => R0 + (R1-R0) * (s/100), []);
  const rBlocker = sR(30), rWatch = sR(60);
  const anyTier = activeTiers.size > 0, anyDomain = activeDomains.size > 0;
  const anyFilter = anyTier || anyDomain;

  const arcR = R1 + 28;
  const arcLabelR = R1 + 46;

  const groupSpans = useMemo(() => {
    const spans = [];
    let currentGroup = null;
    let startIdx = 0;
    petals.forEach((p, i) => {
      if (p.pillar !== currentGroup) {
        if (currentGroup !== null) {
          spans.push({ g: GM[currentGroup], startIdx, endIdx: i - 1 });
        }
        currentGroup = p.pillar;
        startIdx = i;
      }
    });
    if (currentGroup !== null) spans.push({ g: GM[currentGroup], startIdx, endIdx: petals.length - 1 });
    return spans;
  }, [petals]);

  const arcText = (text, cx2, cy2, r, startDeg, endDeg, style) => {
    const chars = text.split('');
    const totalSpan = endDeg - startDeg;
    const textSpan = Math.min(totalSpan * 0.8, chars.length * 1.5);
    const mid = (startDeg + endDeg) / 2;
    const tStart = mid - textSpan / 2;
    const charStep = chars.length > 1 ? textSpan / (chars.length - 1) : 0;
    return chars.map((ch, i) => {
      const angle = chars.length > 1 ? tStart + i * charStep : mid;
      const pos = polar(cx2, cy2, r, angle);
      return <text key={i} x={pos.x} y={pos.y} textAnchor="middle" dominantBaseline="central" transform={`rotate(${angle},${pos.x},${pos.y})`} style={style}>{ch}</text>;
    });
  };

  return (
    <svg viewBox={`0 0 ${Sz} ${Sz}`} style={{ width:"100%" }}>
      {groupSpans.map(({ g, startIdx: si, endIdx: ei }) => {
        const active = activeDomains.has(g.id);
        const hasTierMatch = anyTier && petals.slice(si, ei+1).some(p => activeTiers.has(p.tier));
        const emphasized = active || hasTierMatch;
        const startA = si * step - step/2;
        const endA = ei * step + step/2;
        return (
          <g key={`arc-${g.id}`} style={{ cursor:"pointer" }} onClick={() => onToggleDomain(g.id)}>
            <path d={arcPathFn(cx,cy,arcR,startA+2,endA-2)} fill="none" stroke={g.color} strokeWidth={emphasized?6:3.5} opacity={emphasized?0.9:0.35} strokeLinecap="round" style={{ transition:"all 0.18s" }} />
            {arcText(g.name, cx, cy, arcLabelR, startA+2, endA-2, { fontSize:"0.62rem", fontWeight:emphasized?800:700, fill:emphasized?g.dark:`${g.color}99`, letterSpacing:"0.3px", pointerEvents:"none" })}
          </g>
        );
      })}
      <circle cx={cx} cy={cy} r={rBlocker} fill="none" stroke={C.blocker} strokeWidth={2.5} opacity={0.35} />
      <circle cx={cx} cy={cy} r={rWatch} fill="none" stroke={C.watch} strokeWidth={2.5} opacity={0.35} />
      <circle cx={cx} cy={cy} r={R1} fill="none" stroke={C.clear} strokeWidth={2.5} opacity={0.25} />
      {[25,50,75].map(v => <circle key={v} cx={cx} cy={cy} r={sR(v)} fill="none" stroke={C.ring} strokeWidth={0.4} opacity={0.12} />)}
      {[25,50,75].map(v => <text key={`l${v}`} x={cx+4} y={cy-sR(v)+4} style={{ fontSize:"0.44rem", fill:C.light, fontWeight:700 }}>{v}</text>)}
      {petals.map((_, i) => { const a=i*step,f=polar(cx,cy,R0,a),t=polar(cx,cy,R1+2,a); return <line key={i} x1={f.x} y1={f.y} x2={t.x} y2={t.y} stroke={C.faint} strokeWidth={0.3} opacity={0.2} />; })}
      {petals.map((p, i) => {
        const startA = i*step - step/2, endA = i*step + step/2, midA = i*step;
        const pr = sR(p.score);
        const gr = GM[p.pillar];
        const isSelected = selectedId === p.id;
        const isHovered = hoveredId === p.id;
        const inTier = activeTiers.has(p.tier);
        const inDomain = activeDomains.has(p.pillar);
        const matchesFilter = (anyTier && inTier) || (anyDomain && inDomain);
        const lit = matchesFilter || isSelected || isHovered;

        let fillColor = gr?.color || C.mid;
        let fillOp = 0.25;
        let strokeCol = `${TM[p.tier].color}44`;
        let strokeW = 1;

        if (anyFilter) {
          if (matchesFilter) { fillOp = 0.65; strokeCol = TM[p.tier].color; strokeW = 2.5; }
          else { fillOp = 0.08; }
        }
        if (isHovered && !isSelected) { fillOp = Math.min(fillOp + 0.15, 0.72); strokeW = Math.max(strokeW, 2); strokeCol = TM[p.tier].color; }
        if (isSelected) { fillColor = C.highlight; fillOp = 0.75; strokeCol = C.highlightDark; strokeW = 3.5; }

        const lp = polar(cx,cy,R1+14,midA);
        let ta = "middle";
        if (midA > 15 && midA < 165) ta = "start";
        if (midA > 195 && midA < 345) ta = "end";
        let labelColor = C.light;
        if (isSelected) labelColor = C.highlightDark;
        else if (lit) labelColor = gr?.dark || C.text;

        return (
          <g key={p.id} style={{ cursor:"pointer" }} onClick={() => onClickPetal(p.id)} onMouseEnter={() => onHoverPetal(p.id)} onMouseLeave={() => onHoverPetal(null)}>
            <path d={wedgePath(cx,cy,R0,pr,startA,endA)} fill={fillColor} fillOpacity={fillOp} stroke={strokeCol} strokeWidth={strokeW} style={{ transition:"all 0.18s ease" }} />
            <text x={lp.x} y={lp.y} textAnchor={ta} dominantBaseline="central" style={{ fontSize:"0.54rem", fontWeight:lit?800:600, fill:labelColor, letterSpacing:"0.4px", transition:"fill 0.15s" }}>{p.abbr}</text>
          </g>
        );
      })}
      <circle cx={cx} cy={cy} r={R0-2} fill={C.card} stroke={C.border} strokeWidth={0.6} />
      {(() => {
        const rx = Sz - 16, by = Sz - 16;
        const items = [{ range:"<30", label:"Start Here", color:C.blocker },{ range:"30–60", label:"Building", color:C.watch },{ range:"60+", label:"Working For You", color:C.clear }];
        const topY = by - items.length * 18 - 30;
        return (<g>
          <text x={rx} y={topY} textAnchor="end" style={{ fontSize:"0.5rem", fontWeight:800, fill:C.mid, textTransform:"uppercase", letterSpacing:"1.5px" }}>Chart Rings</text>
          {items.map((item, i) => {
            const iy = topY + 28 + i * 18;
            return (<g key={i}><line x1={rx-125} y1={iy} x2={rx-113} y2={iy} stroke={item.color} strokeWidth={3.5} opacity={0.85} strokeLinecap="round"/><text x={rx-108} y={iy} dominantBaseline="central" style={{ fontSize:"0.5rem", fontWeight:800, fill:item.color }}>{item.range}</text><text x={rx} y={iy} textAnchor="end" dominantBaseline="central" style={{ fontSize:"0.5rem", fontWeight:700, fill:C.mid }}>{item.label}</text></g>);
          })}
        </g>);
      })()}
    </svg>
  );
};

const SidebarPriority = ({ activeTiers, selectedId, hoveredId, onToggleTier, onClickItem, onHoverItem }) => {
  const [collapsed, setCollapsed] = useState({ blocker:false, watch:true, clear:true });
  return (
    <div style={{ display:"flex", flexDirection:"column", gap:4 }}>
      {TIERS.map(tier => {
        const items = ALL_SKILLS.filter(p => p.tier === tier.id);
        const isActive = activeTiers.has(tier.id);
        const isCol = collapsed[tier.id];
        return (
          <div key={tier.id} style={{ borderRadius:12, overflow:"hidden", border:isActive?`2px solid ${tier.color}`:`1px solid ${C.border}`, background:C.card, transition:"all 0.15s" }}>
            <div style={{ display:"flex", alignItems:"center", gap:10, padding:"0.6rem 0.8rem", cursor:"pointer", userSelect:"none", background:isActive?tier.bg:C.card, borderBottom:isCol?"none":`1px solid ${C.border}` }} onClick={() => onToggleTier(tier.id)}>
              <div style={{ width:13, height:13, borderRadius: tier.id === "blocker" ? 2 : "50%", background:tier.color, opacity:isActive?1:0.5 }} />
              <div style={{ flex:1 }}>
                <span style={{ fontSize:T.sm, fontWeight:800, color:isActive?tier.dark:C.text }}>{tier.label}</span>
                <span style={{ fontSize:T.xs, color:C.light, marginLeft:6 }}>({items.length})</span>
              </div>
              <span style={{ fontSize:T.xs, color:C.light, transform:isCol?"rotate(-90deg)":"rotate(0)", transition:"transform 0.2s" }}>▾</span>
            </div>
            {!isCol && (
              <div style={{ padding:"4px 8px 8px" }}>
                {items.map(item => (
                  <SidebarRow key={item.id} item={item} selectedId={selectedId} hoveredId={hoveredId} onClickItem={onClickItem} onHoverItem={onHoverItem} />
                ))}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
};

const SidebarDomain = ({ activeDomains, selectedId, hoveredId, onToggleDomain, onClickItem, onHoverItem }) => {
  const [collapsed, setCollapsed] = useState({});
  return (
    <div style={{ display:"flex", flexDirection:"column", gap:4 }}>
      {GROUPS.map(g => {
        const items = ALL_SKILLS.filter(p => p.pillar === g.id);
        if (items.length === 0) return null;
        const isActive = activeDomains.has(g.id);
        const isCol = collapsed[g.id];
        return (
          <div key={g.id} style={{ borderRadius:12, overflow:"hidden", border:isActive?`2px solid ${g.color}`:`1px solid ${C.border}`, background:C.card, transition:"all 0.15s" }}>
            <div style={{ display:"flex", alignItems:"center", gap:10, padding:"0.6rem 0.8rem", cursor:"pointer", userSelect:"none", background:isActive?`${g.light}33`:C.card, borderBottom:isCol?"none":`1px solid ${C.border}` }} onClick={() => onToggleDomain(g.id)}>
              <div style={{ width:13, height:13, borderRadius:"50%", background:g.color, opacity:isActive?1:0.5 }} />
              <div style={{ flex:1 }}>
                <span style={{ fontSize:T.sm, fontWeight:800, color:isActive?g.dark:C.text }}>{g.name}</span>
                <span style={{ fontSize:T.xs, color:C.light, marginLeft:6 }}>({items.length})</span>
              </div>
              <div style={{ display:"flex", gap:2 }}>
                {items.map(it => <span key={it.id} style={{ width:6, height:6, borderRadius: it.tier === "blocker" ? 1.5 : "50%", background:TM[it.tier].color, opacity:0.6 }} />)}
              </div>
              <span style={{ fontSize:T.xs, color:C.light, transform:isCol?"rotate(-90deg)":"rotate(0)", transition:"transform 0.2s", cursor:"pointer" }} onClick={(e) => { e.stopPropagation(); setCollapsed(p => ({...p,[g.id]:!p[g.id]})); }}>▾</span>
            </div>
            {!isCol && (
              <div style={{ padding:"4px 8px 8px" }}>
                {items.map(item => (
                  <SidebarRow key={item.id} item={item} selectedId={selectedId} hoveredId={hoveredId} onClickItem={onClickItem} onHoverItem={onHoverItem} />
                ))}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
};

const SidebarRow = ({ item, selectedId, hoveredId, onClickItem, onHoverItem }) => {
  const gr = GM[item.pillar];
  const isSel = selectedId === item.id;
  const isHov = hoveredId === item.id;
  return (
    <div onClick={() => onClickItem(item.id)} onMouseEnter={() => onHoverItem(item.id)} onMouseLeave={() => onHoverItem(null)}
      style={{ display:"flex", alignItems:"center", gap:7, padding:"4px 8px", borderRadius:7, cursor:"pointer", background:isSel?`${C.highlightLight}88`:isHov?C.bg:"transparent", border:isSel?`2px solid ${C.highlight}`:"2px solid transparent", transition:"all 0.1s", marginBottom:1 }}>
      <div style={{ display: "flex", alignItems: "center", justifyContent: "center", width: 12, height: 12 }}>
        <div style={{ width:10, height:10, borderRadius: 2, background: item.tier === "blocker" ? C.blocker : (gr?.color||C.mid), opacity:isSel?1:0.55 }} />
      </div>
      <span style={{ fontSize:T.sm, fontWeight:isSel?800:600, color:isSel?C.highlightDark:C.text, flex:1 }}>{item.name}</span>
      <span style={{ fontSize:T.sm, fontWeight:800, color:isSel?C.highlightDark:TM[item.tier].color, minWidth:22, textAlign:"right" }}>{item.score}</span>
    </div>
  );
};

const CoachDrawer = ({ skill, tab, setTab, onClose }) => {
  const ct = skill.coachText;
  const st = skill.studentText;
  const gr = GM[skill.pillar];
  const conn = CONNECTIONS[skill.id];
  const drawerRef = useRef(null);
  const closeRef = useRef(null);

  useEffect(() => {
    const handleKey = (e) => { if (e.key === "Escape") onClose(); };
    document.addEventListener("keydown", handleKey);
    document.body.style.overflow = "hidden";
    if (closeRef.current) closeRef.current.focus();
    return () => {
      document.removeEventListener("keydown", handleKey);
      document.body.style.overflow = "";
    };
  }, [onClose]);

  return (
    <>
    <div onClick={onClose} style={{ position:"fixed", inset:0, background:"rgba(0,0,0,0.15)", zIndex:99, animation:"fadeIn 0.15s ease" }} aria-hidden="true" />
    <div ref={drawerRef} role="dialog" aria-modal="true" aria-label={`${skill.name} detail`} style={{ position:"fixed", top:0, right:0, width:"min(520px, 90vw)", height:"100vh", background:C.card, borderLeft:`1px solid ${C.border}`, boxShadow:"-4px 0 24px -6px rgba(0,0,0,0.1)", animation:"drawerIn 0.25s ease", zIndex:100, display:"flex", flexDirection:"column", overflow:"hidden" }}>
      <div style={{ padding:`${S.lg}px ${S.xl}px`, borderBottom:`1px solid ${C.border}`, flexShrink:0 }}>
        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start" }}>
          <div>
            <div style={{ display:"flex", alignItems:"center", gap:S.sm, marginBottom:4 }}>
              <div style={{ width:12, height:12, borderRadius: 3, background: skill.tier === "blocker" ? C.blocker : (gr?.color||C.mid) }} />
              <h3 style={{ margin:0, fontSize:T.xl, fontWeight:800, color:C.text }}>{skill.name}</h3>
            </div>
            <div style={{ display:"flex", alignItems:"center", gap:S.sm, flexWrap:"wrap" }}>
              <span style={{ fontSize:T.lg, fontWeight:900, color:TM[skill.tier].color }}>{skill.score}</span>
              <TierBadge tier={skill.tier} size="md" />
              {skill.strategyLabel && <span style={{ fontSize:T.xs, fontWeight:600, color:C.mid, padding:"2px 8px", borderRadius:4, background:C.bg }}>{skill.strategyLabel}</span>}
            </div>
            {skill.gloss && <p style={{ margin:`4px 0 0`, fontSize:T.sm, color:C.mid, fontStyle:"italic" }}>{skill.gloss}</p>}
          </div>
          <button ref={closeRef} onClick={onClose} aria-label="Close drawer" style={{ background:"none", border:"none", cursor:"pointer", fontSize:T.lg, color:C.light, padding:4 }}>✕</button>
        </div>
        <div style={{ display:"flex", gap:0, marginTop:S.md }}>
          {[{k:"student",l:"Your Profile"},{k:"coach",l:"Coach Notes"}].map(v => (
            <button key={v.k} onClick={() => setTab(v.k)} style={{ flex:1, padding:`${S.sm}px`, border:"none", cursor:"pointer", fontFamily:"inherit", background:tab===v.k?C.text:"transparent", color:tab===v.k?"#fff":C.mid, fontWeight:tab===v.k?800:600, fontSize:T.sm, borderRadius:tab===v.k?"6px 6px 0 0":"6px 6px 0 0", transition:"all 0.15s" }}>{v.l}</button>
          ))}
        </div>
      </div>
      <div style={{ flex:1, overflowY:"auto", padding:`${S.lg}px ${S.xl}px` }}>
        {tab === "student" && <StudentDetail skill={skill} />}
        {tab === "coach" && (
          <div style={{ display:"flex", flexDirection:"column", gap:S.lg }}>
            {skill.strategyType && (
              <div style={{ padding:S.md, borderRadius:8, background:C.bg, border:`1px solid ${C.border}` }}>
                <div style={{ fontSize:T.xs, fontWeight:700, color:C.mid, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:6 }}>Strategy Type</div>
                <div style={{ display:"flex", alignItems:"center", gap:S.sm, flexWrap:"wrap" }}>
                  <span style={{ fontSize:T.base, fontWeight:800, color:C.text }}>{skill.strategyLabel}</span>
                  <span style={{ fontSize:T.xs, padding:"2px 6px", borderRadius:4, background:C.purple+"15", color:C.purple, fontWeight:700 }}>EF-{skill.efTier}</span>
                  <span style={{ fontSize:T.xs, padding:"2px 6px", borderRadius:4, background:C.pink+"15", color:C.pink, fontWeight:700 }}>ARC: {skill.arcState}</span>
                </div>
              </div>
            )}
            <div style={{ padding:S.md, borderRadius:8, borderLeft:`3px solid ${gr?.color||C.mid}`, background:`${gr?.light||C.bg}22` }}>
              <div style={{ fontSize:T.xs, fontWeight:700, color:gr?.dark||C.text, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:4 }}>Direction</div>
              <p style={{ margin:0, fontSize:T.base, color:C.text, lineHeight:1.55 }}>{ct.coachingDirection}</p>
            </div>
            <div>
              <div style={{ fontSize:T.xs, fontWeight:700, color:C.mid, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:6 }}>What to Build On</div>
              <p style={{ margin:0, fontSize:T.base, color:C.text, lineHeight:1.55 }}>{ct.strengthsLeverage}</p>
            </div>
            <div>
              <div style={{ fontSize:T.xs, fontWeight:700, color:C.mid, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:6 }}>Pattern Summary</div>
              <p style={{ margin:0, fontSize:T.base, color:C.text, lineHeight:1.55 }}>{ct.clinicalSummary}</p>
            </div>
            <div>
              <div style={{ fontSize:T.xs, fontWeight:700, color:C.mid, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:6 }}>Competing Hypotheses</div>
              <p style={{ margin:0, fontSize:T.base, color:C.text, lineHeight:1.55 }}>{ct.hypotheses}</p>
            </div>
            <div style={{ padding:S.md, borderRadius:8, background:C.blockerBg, border:`1px solid ${C.blocker}20` }}>
              <div style={{ fontSize:T.xs, fontWeight:700, color:C.blockerDark, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:4 }}>Before You Proceed</div>
              <p style={{ margin:`0 0 ${S.sm}px`, fontSize:T.sm, color:C.mid, lineHeight:1.5, fontStyle:"italic" }}>{ct.ruleOutPrompt}</p>
              {ct.ruleOutChecklist.map((item, i) => (
                <label key={i} style={{ display:"flex", alignItems:"flex-start", gap:S.sm, marginBottom:6, cursor:"pointer" }}>
                  <input type="checkbox" style={{ marginTop:3, flexShrink:0 }} />
                  <span style={{ fontSize:T.sm, color:C.text, lineHeight:1.5 }}>{item}</span>
                </label>
              ))}
            </div>
            <div>
              <div style={{ fontSize:T.xs, fontWeight:700, color:C.mid, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:6 }}>Coaching Sequence</div>
              <p style={{ margin:0, fontSize:T.base, color:C.text, lineHeight:1.6 }}>{ct.scaffoldSequence}</p>
            </div>
            <div style={{ padding:S.md, borderRadius:8, background:C.bg }}>
              <div style={{ fontSize:T.xs, fontWeight:700, color:C.mid, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:8 }}>Feedback Frame</div>
              {ct.feedbackStructure.split('\n').map((line, i) => (
                <p key={i} style={{ margin:i>0?"8px 0 0":0, fontSize:T.sm, color:C.text, lineHeight:1.5 }}>{line}</p>
              ))}
            </div>
            <div style={{ padding:S.md, borderRadius:8, borderLeft:`3px solid ${C.purple}`, background:C.purpleBg }}>
              <div style={{ fontSize:T.xs, fontWeight:700, color:C.purpleDark, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:4 }}>Equity Check</div>
              <p style={{ margin:0, fontSize:T.base, color:C.text, lineHeight:1.55 }}>{ct.equityNote}</p>
            </div>
            {conn && (
              <div style={{ padding:S.md, borderRadius:8, background:`${C.purple}08`, border:`1px solid ${C.purple}20` }}>
                <div style={{ fontSize:T.xs, fontWeight:700, color:C.purpleDark, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:6 }}>Connected Skills (Cascade)</div>
                <p style={{ margin:`0 0 ${S.sm}px`, fontSize:T.sm, color:C.mid, lineHeight:1.5, fontStyle:"italic" }}>{conn.note}</p>
                <div style={{ display:"flex", flexWrap:"wrap", gap:S.sm }}>
                  {conn.affects.map(id => {
                    const target = PM[id];
                    if (!target) return null;
                    const tgr = GM[target.pillar];
                    return (
                      <span key={id} style={{ display:"inline-flex", alignItems:"center", gap:4, padding:`${S.xs}px ${S.sm}px`, borderRadius:S.sm, background:TM[target.tier].bg, border:`1.5px solid ${TM[target.tier].color}30` }}>
                        {target.tier === "blocker" ? <div style={{ width:8, height:8, borderRadius:2, background:C.blocker, flexShrink:0 }} /> : <span style={{ width:8, height:8, borderRadius:2, background:tgr?.color||C.mid }} />}
                        <span style={{ fontSize:T.sm, fontWeight:600, color:C.text }}>{target.name}</span>
                        <span style={{ fontSize:T.sm, fontWeight:800, color:TM[target.tier].color }}>{target.score}</span>
                      </span>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
    </>
  );
};

/* ═════════════════════════════════════════════════
   VIEW 3: EXPLORE (Card Grid)
   ═════════════════════════════════════════════════ */
const ExploreView = ({ expandedId, onToggle }) => {
  const allGroups = [
    ...PILLARS.map(p => ({ ...p, skills: DURABLE_SKILLS.filter(s => s.pillar === p.id) })),
    { id:"ef", name:"Executive Function", color:C.purple, dark:C.purpleDark, tagline:"How your mind processes information", skills: EF_SKILLS },
    { id:"arc", name:"ARC Needs", color:C.pink, dark:C.pinkDark, tagline:"Whether your core needs are being met", skills: ARC_SKILLS },
  ];
  return (
    <div style={{ display:"flex", flexDirection:"column", gap:S.xxl }}>
      {allGroups.map(group => (
        <div key={group.id}>
          <div style={{ display:"flex", alignItems:"center", gap:S.sm, marginBottom:S.md }}>
            <div style={{ width:4, height:24, borderRadius:2, background:group.color }} />
            <div>
              <h3 style={{ fontSize:T.md, fontWeight:800, color:group.dark, margin:0 }}>{group.name}</h3>
              <p style={{ fontSize:T.xs, color:C.mid, margin:0 }}>{group.tagline}</p>
            </div>
          </div>
          <div style={{ display:"flex", flexDirection:"column", gap:S.sm }}>
            {group.skills.map(skill => (
              <SkillCard key={skill.id} skill={skill} isExpanded={expandedId===skill.id} onToggle={() => onToggle(skill.id)} />
            ))}
          </div>
        </div>
      ))}
    </div>
  );
};

/* ═════════════════════════════════════════════════
   MAIN COMPONENT
   ═════════════════════════════════════════════════ */
export default function C2AStudentProfile() {
  const [view, setView] = useState("profile");
  const [expandedId, setExpandedId] = useState(null);

  const handleToggle = (id) => setExpandedId(prev => prev === id ? null : id);
  const handleViewSelect = useCallback((id) => { setView(id); setExpandedId(null); }, []);
  const handleViewTabKey = useTabKeyboard(VIEW_MODES, view, handleViewSelect);

  return (
    <div style={{ maxWidth:1200, margin:"0 auto", padding:`${S.xl}px ${S.xxl}px`, fontFamily:'-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,sans-serif', background:C.bg, minHeight:"100vh" }}>
      <div style={{ marginBottom:S.xxxl }}>
        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-end", flexWrap:"wrap", gap:S.md }}>
          <div>
            <h1 style={{ fontSize:T.xxl, fontWeight:800, color:C.text, margin:0, lineHeight:1.1 }}>Carlos's Profile</h1>
            <p style={{ margin:`${S.sm}px 0 0`, fontSize:T.sm, color:C.mid, fontStyle:"italic" }}>These scores are a snapshot — where you are now, not where you'll stay.</p>
          </div>
          <div style={{ display:"flex", background:C.card, borderRadius:10, border:`1px solid ${C.border}`, overflow:"hidden" }} role="tablist" onKeyDown={handleViewTabKey}>
            {VIEW_MODES.map(v => (
              <button key={v.id} role="tab" aria-selected={view===v.id} tabIndex={view===v.id?0:-1} onClick={() => handleViewSelect(v.id)}
                style={{ padding:`${S.sm}px ${S.lg}px`, border:"none", cursor:"pointer", fontFamily:"inherit", background:view===v.id?C.text:"transparent", color:view===v.id?"#fff":C.mid, fontWeight:view===v.id?800:600, fontSize:T.sm, transition:"all 0.15s", outline:view===v.id?`2px solid ${C.watch}`:"none", outlineOffset:-2 }}
                title={v.desc}>{v.label}</button>
            ))}
          </div>
        </div>
      </div>

      {view === "profile" && <MyProfileView expandedId={expandedId} onToggle={handleToggle} />}
      {view === "full" && <FullPictureView />}
      {view === "explore" && <ExploreView expandedId={expandedId} onToggle={handleToggle} />}

      <style>{`
        @keyframes fadeIn { from { opacity:0; transform:translateY(6px) } to { opacity:1; transform:translateY(0) } }
        @keyframes drawerIn { from { transform:translateX(100%) } to { transform:translateX(0) } }
        * { box-sizing: border-box; }
      `}</style>
    </div>
  );
}
